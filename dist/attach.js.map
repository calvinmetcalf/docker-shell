{"version":3,"sources":["../lib/attach.js"],"names":["attach","debug","container","started","logs","stream","stdin","stdout","stderr","then","streamc","reject","Error","start","spawn","bind","kill","remove","force","v","command","args","options","proc","write","JSON","stringify","type","PassThrough","demux","pipe","split","parse","mapSync","data","event","emit","code","removeListener","unpipe","setTimeout"],"mappings":"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","file":"attach.js","sourcesContent":["import Bluebird from 'bluebird';\nimport { EventEmitter } from 'events';\nimport setupDebug from 'debug';\nimport es from 'event-stream';\nimport stream from 'stream';\nimport demuxer from './demuxer';\n\nconst debug = setupDebug('docker-shell:attach');\n\nexport default function attach(container, started) {\n  return container.attach({\n    logs: true,\n    stream: true,\n    stdin: true,\n    stdout: true,\n    stderr: true\n  }).then((streamc) => {\n    if (!streamc) return Bluebird.reject(new Error('Failed to attach container stream'));\n\n    if (!started) {\n      debug('starting container');\n      // start, and wait for it to be done\n      return container.start().then(() => {\n        debug('started container');\n/*\n        container.wait()\n          .then((res) => {\n            debug('done with container, success', res);\n            container.stop();\n          })\n          .catch((err) => {\n            debug('done with container, erred', err);\n            container.stop();\n          });\n*/\n      }).then(() => {\n        return {\n          spawn: spawn.bind(null, streamc),\n          kill,\n          container\n        };\n      });\n    }\n\n    return {\n      spawn: spawn.bind(null, streamc),\n      kill,\n      container\n    };\n  })\n\n  function kill() {\n    return container.remove({\n      force: true, // Stop container and remove\n      v: true // Remove any attached volumes\n    });\n  }\n\n  function spawn(streamc, command, args, options) {\n    debugger;\n    const proc = new EventEmitter();\n\n    proc.kill = function () {\n      streamc.write(`${JSON.stringify({type: 'kill'})}\\n`);\n    };\n    proc.stdout = new stream.PassThrough();\n    proc.stderr = new stream.PassThrough();\n    proc.stdin = streamc;\n\n    var stdout = new stream.PassThrough();\n    var stderr = new stream.PassThrough();\n    const demux = demuxer(streamc, stdout, stderr);\n\n    stderr\n      .pipe(es.split())\n      .pipe(es.parse())\n      .pipe(es.mapSync(function (data) {\n        debug('got an err event', data);\n      }));\n\n    stdout\n      .pipe(es.split())\n      .pipe(es.parse())\n      .pipe(es.mapSync(function (data) {\n        debug('got an event', data);\n        if (data.event === 'stdout') {\n          proc.stdout.write(data.data);\n        }\n        if (data.event === 'stderr') {\n          proc.stderr.write(data.data);\n        }\n        if (data.event === 'exit') {\n          proc.emit('exit', data.code);\n          streamc.removeListener('readable', demux);\n          stdout.unpipe();\n        }\n      }));\n\n    debug('running command', command);\n    debug('with args', args);\n\n    setTimeout(function() {\n      streamc.write(`${JSON.stringify({command: command, args: args, type: 'start'})}\\n`);\n    }, 500);\n\n    return proc;\n  }\n}\n"]}